<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カタカムナ検索表（ことだま辞典）</title>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --text:#e6e8ef; --muted:#9aa3b2;
    --primary:#4aa8ff; --accent:#22d3ee; --line:#243246; --btn:#1f2531;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 14px}
  .note{color:var(--muted);font-size:12px;margin-bottom:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
  input[type="search"]{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:8px;min-width:240px;outline:none}
  .btn{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:9px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{border-color:var(--primary);color:#fff;background:#2563eb}
  .btn:hover{filter:brightness(1.08)}
  .file{display:inline-block;position:relative}
  .file input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .count{margin-left:auto;color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid var(--line);padding:12px 14px;vertical-align:top}
  th{background:#111827;text-align:left;color:#b8c0cc;font-weight:600}
  tr:last-child td{border-bottom:none}
  .kana{font-size:18px;font-weight:700}
  .rom{color:var(--muted)}
  .mean li{line-height:1.6}
  .ops .btn{padding:6px 10px;font-size:13px}
  .muted{color:var(--muted)}
  /* 簡易モーダル */
  dialog{border:none;border-radius:12px;background:#0f1522;color:var(--text);width:min(720px,90vw)}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .dlg-b{padding:14px 16px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
  textarea{width:100%;min-height:220px;background:var(--panel);border:1px solid var(--line);border-radius:8px;color:var(--text);padding:10px 12px;outline:none}
  .tips{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>カタカムナ検索表（ことだま辞典）</h1>
  <div class="note">※解釈には流派差があります。ここでは <b>編集可能な個人用辞典</b> として使えます（ブラウザに自動保存）。別端末と共有したい場合は「エクスポート」した JSON をリポジトリの <code>katakamuna-data.json</code> に上書きし、他端末で「初期データに戻す」を押してください。</div>

  <div class="toolbar">
    <input id="q" type="search" placeholder="検索（例：ア / a / ari）" />
    <button id="clear" class="btn">クリア</button>

    <span class="count" id="cnt"></span>
  </div>

  <div class="toolbar">
    <button id="export" class="btn">エクスポート(JSON)</button>

    <label class="file btn">
      インポート
      <input id="import" type="file" accept="application/json" />
    </label>

    <button id="resetBtn" class="btn">初期データに戻す</button>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:80px">五十音</th>
        <th style="width:100px">ローマ字</th>
        <th>意味（編集可）</th>
        <th style="width:90px">操作</th>
      </tr>
    </thead>
    <tbody id="tbl"></tbody>
  </table>
</div>

<!-- 簡易編集ダイアログ -->
<dialog id="dlg">
  <div class="dlg-h" id="dlg-title">編集</div>
  <div class="dlg-b">
    <textarea id="ta" spellcheck="false"></textarea>
    <div class="tips">※ 1行につき1つの意味。空行は無視されます。</div>
  </div>
  <div class="dlg-f">
    <button id="dlg-cancel" class="btn">キャンセル</button>
    <button id="dlg-ok" class="btn primary">保存</button>
  </div>
</dialog>

<script>
/* =========================
   データ構造
   [{kana:'ア', romaji:'a', meanings:['…','…']}, …]
   ========================= */
const DEFAULT_DATA = [
  // ア行
  {kana:'ア',romaji:'a',meanings:[]},
  {kana:'イ',romaji:'i',meanings:[]},
  {kana:'ウ',romaji:'u',meanings:[]},
  {kana:'エ',romaji:'e',meanings:[]},
  {kana:'オ',romaji:'o',meanings:[]},
  // カ行
  {kana:'カ',romaji:'ka',meanings:[]},
  {kana:'キ',romaji:'ki',meanings:[]},
  {kana:'ク',romaji:'ku',meanings:[]},
  {kana:'ケ',romaji:'ke',meanings:[]},
  {kana:'コ',romaji:'ko',meanings:[]},
  // サ行
  {kana:'サ',romaji:'sa',meanings:[]},
  {kana:'シ',romaji:'si',meanings:[]},
  {kana:'ス',romaji:'su',meanings:[]},
  {kana:'セ',romaji:'se',meanings:[]},
  {kana:'ソ',romaji:'so',meanings:[]},
  // タ行
  {kana:'タ',romaji:'ta',meanings:[]},
  {kana:'チ',romaji:'ti',meanings:[]},
  {kana:'ツ',romaji:'tu',meanings:[]},
  {kana:'テ',romaji:'te',meanings:[]},
  {kana:'ト',romaji:'to',meanings:[]},
  // ナ行
  {kana:'ナ',romaji:'na',meanings:[]},
  {kana:'ニ',romaji:'ni',meanings:[]},
  {kana:'ヌ',romaji:'nu',meanings:[]},
  {kana:'ネ',romaji:'ne',meanings:[]},
  {kana:'ノ',romaji:'no',meanings:[]},
  // ハ行
  {kana:'ハ',romaji:'ha',meanings:[]},
  {kana:'ヒ',romaji:'hi',meanings:[]},
  {kana:'フ',romaji:'hu',meanings:[]},
  {kana:'ヘ',romaji:'he',meanings:[]},
  {kana:'ホ',romaji:'ho',meanings:[]},
  // マ行
  {kana:'マ',romaji:'ma',meanings:[]},
  {kana:'ミ',romaji:'mi',meanings:[]},
  {kana:'ム',romaji:'mu',meanings:[]},
  {kana:'メ',romaji:'me',meanings:[]},
  {kana:'モ',romaji:'mo',meanings:[]},
  // ヤ行
  {kana:'ヤ',romaji:'ya',meanings:[]},
  {kana:'ユ',romaji:'yu',meanings:[]},
  {kana:'ヨ',romaji:'yo',meanings:[]},
  // ラ行
  {kana:'ラ',romaji:'ra',meanings:[]},
  {kana:'リ',romaji:'ri',meanings:[]},
  {kana:'ル',romaji:'ru',meanings:[]},
  {kana:'レ',romaji:'re',meanings:[]},
  {kana:'ロ',romaji:'ro',meanings:[]},
  // ワ行（ヰ・ヱを追加）
  {kana:'ワ',romaji:'wa',meanings:[]},
  {kana:'ヰ',romaji:'wi',meanings:[]},  // 追加
  {kana:'ヱ',romaji:'we',meanings:[]},  // 追加
  {kana:'ヲ',romaji:'wo',meanings:[]},
  {kana:'ン',romaji:'n',meanings:[]},
];

const STORAGE_KEY = "katakamunaData.v1";

function getLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  try{
    const data = JSON.parse(raw);
    return (Array.isArray(data) && data.length) ? data : null;
  }catch(e){ return null; }
}
function saveLocal(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

let DATA = [];

/* -------- リポジトリ JSON 読み込み（キャッシュ回避） -------- */
async function fetchRepoJson(){
  try{
    const res = await fetch('katakamuna-data.json?ts=' + Date.now(), {cache: 'no-store'});
    if(res.ok){
      const arr = await res.json();
      if(Array.isArray(arr) && arr.length) return arr;
    }
  }catch(e){ /* ignore */ }
  return null;
}

/* -------- 初期化：localStorage → repo JSON → default -------- */
async function init(){
  let data = getLocal();
  if(!data) data = await fetchRepoJson();
  if(!data) data = DEFAULT_DATA.slice(); // deep copy
  DATA = data;
  saveLocal(DATA);
  render();
}

/* =========================
   表描画＆検索
   ========================= */
const $q   = document.getElementById('q');
const $tbl = document.getElementById('tbl');
const $cnt = document.getElementById('cnt');

function render(q=""){
  const key = q.trim().toLowerCase();
  $tbl.innerHTML = "";
  let shown = 0;

  DATA.forEach((row, idx)=>{
    const hit = !key ||
      row.kana.includes(key) ||
      row.romaji.toLowerCase().includes(key) ||
      row.meanings.join("\n").toLowerCase().includes(key);

    if(!hit) return;

    shown++;
    const tr = document.createElement('tr');

    const tdKana = document.createElement('td');
    tdKana.innerHTML = `<div class="kana">${row.kana}</div>`;
    tr.appendChild(tdKana);

    const tdRom = document.createElement('td');
    tdRom.innerHTML = `<div class="rom">${row.romaji}</div>`;
    tr.appendChild(tdRom);

    const tdMean = document.createElement('td');
    tdMean.className = "mean";
    if(row.meanings && row.meanings.length){
      const ul = document.createElement('ul');
      row.meanings.forEach(m=>{
        const li = document.createElement('li'); li.textContent = m; ul.appendChild(li);
      });
      tdMean.appendChild(ul);
    }else{
      tdMean.innerHTML = `<span class="muted">(未入力)</span>`;
    }
    tr.appendChild(tdMean);

    const tdOps = document.createElement('td');
    tdOps.className = "ops";
    const btn = document.createElement('button');
    btn.className = "btn"; btn.textContent = "編集";
    btn.addEventListener('click', ()=>openEditor(idx));
    tdOps.appendChild(btn);
    tr.appendChild(tdOps);

    $tbl.appendChild(tr);
  });

  $cnt.textContent = `件数: ${shown}`;
}

/* =========================
   エディタ（簡易ダイアログ）
   ========================= */
const $dlg = document.getElementById('dlg');
const $dlgTitle = document.getElementById('dlg-title');
const $ta  = document.getElementById('ta');
const $ok  = document.getElementById('dlg-ok');
const $cancel = document.getElementById('dlg-cancel');

let editingIndex = -1;

function openEditor(index){
  editingIndex = index;
  const row = DATA[index];
  $dlgTitle.textContent = `「${row.kana} / ${row.romaji}」の意味を編集`;
  $ta.value = (row.meanings || []).join("\n");
  $dlg.showModal();
  setTimeout(()=>{$ta.focus();$ta.selectionStart=$ta.value.length;$ta.selectionEnd=$ta.value.length;},0);
}

$ok.addEventListener('click', ()=>{
  if(editingIndex<0) return $dlg.close();
  const lines = $ta.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  DATA[editingIndex].meanings = lines;
  saveLocal(DATA);
  render($q.value);
  $dlg.close();
});
$cancel.addEventListener('click', ()=> $dlg.close());

/* =========================
   操作：検索 / クリア / エクスポート / インポート / 初期化
   ========================= */
document.getElementById('clear').addEventListener('click', ()=>{
  $q.value=""; render("");
});
$q.addEventListener('input', ()=> render($q.value));

document.getElementById('export').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'katakamuna-data.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('import').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const arr = JSON.parse(txt);
    if(Array.isArray(arr) && arr.length){
      DATA = arr; saveLocal(DATA); render($q.value);
      alert('インポートしました。必要ならこの JSON をリポジトリにも上書きしてください。');
    }else{
      alert('JSON の形式が不正です。');
    }
  }catch(err){
    alert('読み込みに失敗しました: '+err.message);
  }finally{
    e.target.value='';
  }
});

/* 「初期データに戻す」= リポジトリ JSON の再読込（失敗時は DEFAULT） */
document.getElementById('resetBtn').addEventListener('click', async ()=>{
  if(!confirm('リポジトリ上の JSON を読み直します。編集中の内容は上書きされます。よろしいですか？')) return;
  let fresh = await fetchRepoJson();
  if(!fresh) fresh = DEFAULT_DATA.slice();
  DATA = fresh; saveLocal(DATA); render($q.value);
});

/* 起動 */
init();
</script>
</body>
</html>
